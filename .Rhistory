browserName = "firefox"
)
ff_driver$open()
search_n_scrape <- function(url, keyword = "police") {
ff_driver$navigate(url)
Sys.sleep(15)
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
search$sendKeysToElement(list(keyword, key = "enter"))
lis <- map(1:12, possibly(function(i) {
# sleep 15 seconds since it loads really slowly
Sys.sleep(15)
container <- ff_driver$getPageSource()[[1]] %>%
read_html() %>%
html_node("ul.search-results-listing-container")
lis <- container %>%
html_nodes("li.list-item")
next_button <- ff_driver$findElement(using = "css selector", "li.PagedList-skipToNext>a")
next_button$clickElement()
lis
}, NULL))
}
search_n_scrape(hr_url)
library(tidyverse)
library(rvest)
library(httr)
library(RSelenium)
system("docker run -d -p 4445:4444 -p 5901:5900 selenium/standalone-firefox-debug")
hr_url <- "https://www.governmentjobs.com/careers/baltimorecity/classspecs"
# url <- "https://www.governmentjobs.com/careers/classspecifications/index?agency=baltimorecity&sort=ClassTitle&isDescendingSort=false&_=1554870658883"
ff_driver <- remoteDriver(
# remoteServerAddr = "localhost",
port = 4445L,
javascript = T,
browserName = "firefox"
)
ff_driver$open()
search_n_scrape <- function(url, keyword = "police") {
ff_driver$navigate(url)
Sys.sleep(15)
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
search$sendKeysToElement(list(keyword, key = "enter"))
lis <- map(1:12, possibly(function(i) {
# sleep 15 seconds since it loads really slowly
Sys.sleep(15)
container <- ff_driver$getPageSource()[[1]] %>%
read_html() %>%
html_node("ul.search-results-listing-container")
lis <- container %>%
html_nodes("li.list-item")
next_button <- ff_driver$findElement(using = "css selector", "li.PagedList-skipToNext>a")
next_button$clickElement()
lis
}, NULL))
}
search_n_scrape(hr_url)
drvr$close()
ff_driver$close()
debugSource('~/github/Case_Analysis/rselenium_job_codes.R', echo=TRUE)
debugSource('~/github/Case_Analysis/rselenium_job_codes.R', echo=TRUE)
debugSource('~/github/Case_Analysis/rselenium_job_codes.R', echo=TRUE)
class(search)
search$getClass()
?webElement
"152" %>% str_remove_all("\\D") %>% as.numeric() %>% magrittr::divide_by(10) %>% ceiling()
"1,522" %>% str_remove_all("\\D") %>% as.numeric() %>% magrittr::divide_by(10) %>% ceiling()
?tryCatch
system("docker run -d -p 4445:4444 -p 5901:5900 selenium/standalone-firefox-debug")
system("docker run -d -p 4445:4444 -p 5901:5900 selenium/standalone-firefox-debug")
system("docker stop $(docker ps -l -q)")
source('~/github/Case_Analysis/rselenium_job_codes.R', echo=TRUE)
debugSource('~/github/Case_Analysis/rselenium_job_codes.R', echo=TRUE)
system("docker stop $(docker ps -l -q)")
debugSource('~/github/Case_Analysis/rselenium_job_codes.R', echo=TRUE)
ff_driver$close()
ff_driver$close()
debugSource('~/github/Case_Analysis/rselenium_job_codes.R', echo=TRUE)
debugSource('~/github/Case_Analysis/rselenium_job_codes.R', echo=TRUE)
setwd("~/github/bpd_data")
?possibly
?try
tryCatch(stop(e), error = function(e) e, finally = print("Hello"))
withRestarts(invokeRestart("foo", 1, 2), foo = function(x, y) {x + y})
ff_driver$open(silent = T)
ff_driver$navigate(hr_url)
ff_driver$findElement(using = "css selector", "[name='keyword']")
ff_driver$close()
ff_driver$open(silent = T)
ff_driver$navigate(hr_url)
?safely
debugSource('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
system("docker stop $(docker ps -q | head -n 1)")
debugSource('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
system("docker stop $(docker ps -q | head -n 1)")
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
hr_url <- "https://www.governmentjobs.com/careers/baltimorecity/classspecs"
# url <- "https://www.governmentjobs.com/careers/classspecifications/index?agency=baltimorecity&sort=ClassTitle&isDescendingSort=false&_=1554870658883"
ff_driver <- remoteDriver(
remoteServerAddr = "localhost",
port = 4445L,
javascript = T,
browserName = "firefox"
)
ff_driver$open(silent = T)
ff_driver$navigate(hr_url)
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
system("docker stop $(docker ps -q | head -n 1)")
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
search_n_scrape <- function(url, keyword = "police") {
ff_driver$navigate(url)
Sys.sleep(30)
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
search$sendKeysToElement(list(keyword, key = "enter"))
# 10 results per page
page_count <- ff_driver$findElement(using = "css selector", "span#job-postings-number")$getElementText() %>%
str_remove_all("\\D") %>%
as.numeric() %>%
magrittr::divide_by(10) %>%
ceiling()
page_count
# lis <- map(1:page_count, possibly(function(i) {
#   # sleep 15 seconds since it loads really slowly
#   Sys.sleep(15)
#   container <- ff_driver$getPageSource()[[1]] %>%
#     read_html() %>%
#     html_node("ul.search-results-listing-container")
#   lis <- container %>%
#     html_nodes("li.list-item")
#
#   next_button <- ff_driver$findElement(using = "css selector", "li.PagedList-skipToNext>a")
#   next_button$clickElement()
#   lis
# }, NULL))
#
# lis
}
search_n_scrape(hr_url, keyword = "police")
ff_driver$findElement(using = "css selector", "span#job-postings-number")$getElementText()
ff_driver$findElement(using = "css selector", "span#job-postings-number")
ff_driver$findElement(using = "css selector", "span#job-postings-number")$describeElement()
hr_url <- "https://www.governmentjobs.com/careers/baltimorecity/classspecs"
# url <- "https://www.governmentjobs.com/careers/classspecifications/index?agency=baltimorecity&sort=ClassTitle&isDescendingSort=false&_=1554870658883"
ff_driver <- remoteDriver(
remoteServerAddr = "localhost",
port = 4445L,
javascript = T,
browserName = "firefox"
)
ff_driver$open(silent = T)
system("docker run -d -p 4445:4444 -p 5901:5900 selenium/standalone-firefox-debug")
ff_driver <- remoteDriver(
remoteServerAddr = "localhost",
port = 4445L,
javascript = T,
browserName = "firefox"
)
ff_driver$open(silent = T)
ff_driver$navigate(hr_url)
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
system("docker stop $(docker ps -q | head -n 1)")
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
system("docker run -d -p 4445:4444 -p 5901:5900 selenium/standalone-firefox-debug")
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
cop_lis()
search_n_scrape(hr_url)
search_keyword <- function(url, keyword, max_attempts = 3) {
ff_driver$navigate(url)
Sys.sleep(15)
out <- NULL
attempt <- 0
while(is.null(out) && attempt < max_attempts) {
attempt <- attempt + 1
try({
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
search$sendKeysToElement(list(keyword, key = "enter"))
})
}
}
search_keyword(hr_url, "police")
?tryCatch
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
search
tmp <- ff_driver$findElement(using = "css", "#junk")
search_keyword <- function(url, keyword, max_attempts = 3) {
ff_driver$navigate(url)
Sys.sleep(15)
found <- FALSE
attempt <- 0
while(!found && attempt < max_attempts) {
attempt <- attempt + 1
try({
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
if (length(search) > 0) {
search$sendKeysToElement(list(keyword, key = "enter"))
found <- TRUE
}
})
}
}
search_keyword(hr_url, "police")
head(mtcars)
hist(mtcars$disp)
hist(mtcars$wt)
hist(mtcars$wt, breaks = 30)
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
system("docker run -d -p 4445:4444 -p 5901:5900 selenium/standalone-firefox-debug")
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
#
#   next_button <- ff_driver$findElement(using = "css selector", "li.PagedList-skipToNext>a")
#   next_button$clickElement()
#   lis
# }, NULL))
#
# lis
# }
# getting the search box errors the first time...not sure why. Try it a couple times.
# search_keyword <- function(url, keyword, max_attempts = 3) {
ff_driver$navigate(url)
hr_url
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
ff_driver$open(silent = T)
#
#   next_button <- ff_driver$findElement(using = "css selector", "li.PagedList-skipToNext>a")
#   next_button$clickElement()
#   lis
# }, NULL))
#
# lis
# }
# getting the search box errors the first time...not sure why. Try it a couple times.
# search_keyword <- function(url, keyword, max_attempts = 3) {
ff_driver$navigate(hr_url)
found <- FALSE
attempt <- 0
while(!found && attempt < 3) {
attempt <- attempt + 1
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
if (length(search) > 0) {
search$sendKeysToElement(list("police", key = "enter"))
found <- TRUE
}
}
ff_driver$findElement(using = "css selector", "span#job-postings-number")$getElementText()
ff_driver$findElement(using = "css selector", "span#job-postings-number")
ff_driver$findElement(using = "css selector", "span#job-postings-number")$describeElement()
?getElement
?webElement
ff_driver$findElement(using = "css selector", "span#job-postings-number")
ff_driver$findElements(using = "css selector", "span#job-postings-number")
ff_driver$findElements(using = "css selector", ".listing-title")
ff_driver$findElements(using = "css selector", ".listing-title")[[1]]$describeElement()
ff_driver$findElements(using = "tag name", "span")[[1]]$describeElement()
?remoteDriver
ff_driver$findElements(using = "tag name", "span") %>% length()
ff_driver$findElements(using = "tag name", "span#job-postings-number") %>% length()
ff_driver$findElements(using = "css", "#job-postings-number") %>% length()
ff_driver$findElements(using = "css", "#job-postings-number")[[1]]$describeElement()
ff_driver$findElements(using = "css", "#job-postings-number")[[1]]$describeElement()
ff_driver$findElements(using = "css", "#job-postings-number")[[1]]$getElementText()
ff_driver$findElements(using = "css", "#job-postings-number")[[1]]$getElementTagName()
span <- ff_driver$findElements(using = "css selector", "span#job-postings-number")
span <- ff_driver$findElements(using = "css selector", "span#job-postings-number")[[1]]
span$getElementTagName()
span$getElementText()
ff_driver$findElements(using = "css", "h3")[[1]]
ff_driver$findElements(using = "css", "h3")[[1]]$getElementText()
ff_driver$findElements(using = "css selector", "job-posting-number-container") %>% length()
ff_driver$findElements(using = "css selector", ".job-posting-number-container") %>% length()
ff_driver$findElements(using = "css selector", ".job-posting-number-container")[[1]]$getElementText()
ff_driver$findElements(using = "css selector", ".job-posting-number-container")[[1]]$findChildElements("css", "*")
ff_driver$findElements(using = "css selector", ".job-posting-number-container")[[1]]$findChildElements("css", "*")[[1]]$getElementText()
post_count <- ff_driver$findElement(using = "xpath selector", "//*[@id='job-postings-number']")
post_count <- ff_driver$findElement(using = "xpath", "//*[@id='job-postings-number']")
post_count
post_count$getElementText()
post_count$findChildElements("css", "*")
ff_driver$findElement(using = "css selector", "#number-found-items")$getElementText()
ff_driver$findElement(using = "css selector", "#number-found-items")$getElementText() %>%
str_remove_all("\\D")
page_count <- ff_driver$findElement(using = "css selector", "#number-found-items")$getElementText() %>%
str_remove_all("\\D") %>%
as.numeric() %>%
magrittr::divide_by(10) %>%
ceiling()
page_count
ff_driver$close()
system("docker stop $(docker ps -q | head -n 1)")
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
system("docker stop $(docker ps -q | head -n 1)")
system("docker run -d -p 4445:4444 -p 5901:5900 selenium/standalone-firefox-debug")
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
page_count
library(tidyverse)
library(rvest)
library(httr)
library(RSelenium)
# system("docker run -d -p 4445:4444 -p 5901:5900 selenium/standalone-firefox-debug")
hr_url <- "https://www.governmentjobs.com/careers/baltimorecity/classspecs"
# url <- "https://www.governmentjobs.com/careers/classspecifications/index?agency=baltimorecity&sort=ClassTitle&isDescendingSort=false&_=1554870658883"
ff_driver <- remoteDriver(
remoteServerAddr = "localhost",
port = 4445L,
javascript = T,
browserName = "firefox"
)
ff_driver$open(silent = T)
Sys.sleep(10)
# getting the search box errors the first time...not sure why. Try it a couple times.
ff_driver$navigate(hr_url)
Sys.sleep(15)
found <- FALSE
attempt <- 0
while (!found && attempt < 3) {
attempt <- attempt + 1
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
if (length(search) > 0) {
search$sendKeysToElement(list("police", key = "enter"))
found <- TRUE
}
}
page_count <- ff_driver$findElement(using = "css selector", "#number-found-items")$getElementText() %>%
str_remove_all("\\D") %>%
as.numeric() %>%
magrittr::divide_by(10) %>%
ceiling()
ff_driver$close()
ff_driver$open(silent = T)
# getting the search box errors the first time...not sure why. Try it a couple times.
ff_driver$navigate(hr_url)
found <- FALSE
attempt <- 0
while (!found && attempt < 3) {
attempt <- attempt + 1
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
if (length(search) > 0) {
search$sendKeysToElement(list("police", key = "enter"))
found <- TRUE
}
}
ff_driver$close()
library(tidyverse)
library(rvest)
library(httr)
library(RSelenium)
# system("docker run -d -p 4445:4444 -p 5901:5900 selenium/standalone-firefox-debug")
hr_url <- "https://www.governmentjobs.com/careers/baltimorecity/classspecs"
# url <- "https://www.governmentjobs.com/careers/classspecifications/index?agency=baltimorecity&sort=ClassTitle&isDescendingSort=false&_=1554870658883"
ff_driver <- remoteDriver(
remoteServerAddr = "localhost",
port = 4445L,
javascript = T,
browserName = "firefox"
)
ff_driver$open(silent = T)
Sys.sleep(10)
# getting the search box errors the first time...not sure why. Try it a couple times.
ff_driver$navigate(hr_url)
Sys.sleep(15)
found <- FALSE
attempt <- 0
while (!found && attempt < 3) {
attempt <- attempt + 1
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
if (length(search) > 0) {
search$sendKeysToElement(list("police", key = "enter"))
found <- TRUE
}
}
ff_driver$errorDetails)
ff_driver$errorDetails()
library(tidyverse)
library(rvest)
library(httr)
library(RSelenium)
# system("docker run -d -p 4445:4444 -p 5901:5900 selenium/standalone-firefox-debug")
hr_url <- "https://www.governmentjobs.com/careers/baltimorecity/classspecs"
# url <- "https://www.governmentjobs.com/careers/classspecifications/index?agency=baltimorecity&sort=ClassTitle&isDescendingSort=false&_=1554870658883"
ff_driver <- remoteDriver(
remoteServerAddr = "localhost",
port = 4445L,
javascript = T,
browserName = "firefox"
)
ff_driver$open(silent = T)
Sys.sleep(10)
# getting the search box errors the first time...not sure why. Try it a couple times.
ff_driver$navigate(hr_url)
Sys.sleep(15)
found <- FALSE
attempt <- 0
while (!found && attempt < 3) {
attempt <- attempt + 1
search <- ff_driver$findElement(using = "css selector", "[name='keyword']")
if (length(search) > 0) {
search$sendKeysToElement(list("police", key = "enter"))
found <- TRUE
}
}
page_count <- ff_driver$findElement(using = "css selector", "#number-found-items")$getElementText() %>%
str_remove_all("\\D") %>%
as.numeric() %>%
magrittr::divide_by(10) %>%
ceiling()
page_count
cop_lis <- map(1:page_count, possibly(function(i) {
# sleep 15 seconds since it loads really slowly
Sys.sleep(15)
container <- ff_driver$getPageSource()[[1]] %>%
read_html() %>%
html_node("ul.search-results-listing-container")
lis <- container %>%
html_nodes("li.list-item")
next_button <- ff_driver$findElement(using = "css selector", "li.PagedList-skipToNext>a")
next_button$clickElement()
lis
}, NULL))
source('~/github/bpd_data/job_codes/rselenium_job_codes.R', echo=TRUE)
setwd("~/github/bpd_data/job_codes")
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(tidyverse)
library(lubridate)
library(DBI)
library(RPostgreSQL)
library(igraph)
library(tidygraph)
library(stringdist)
library(ggraph)
drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname = "mjcs",
user = "mjcs_ro",
password = rstudioapi::askForPassword("password"),
port = 5432,
host = "mjcs.c7q0zmxhx4uo.us-east-1.rds.amazonaws.com")
cops %>%
filter(!is.na(name)) %>%
distinct(name, officer_id) %>%
arrange(name) %>%
group_by(name) %>%
mutate(n = n()) %>%
filter(n > 1)
cops
library(refinr)
cop_df <- cops %>%
as_tibble() %>%
filter(!is.na(name)) %>%
arrange(case_number, name) %>%
mutate(name = name %>%
str_replace(",(?=\\w)", ", ") %>%
str_remove_all("[\\d\\.]") %>%
str_remove_all("\\bOF+(C|R)?") %>%
str_remove_all("\\bJR\\b") %>%
str_remove_all("III") %>%
str_remove("\\s(?=,)") %>%
str_trim() %>%
str_remove_all("\\s(\\w|II)$") %>%
str_remove_all("\\s{2,}") %>%
# str_remove("\\s\\w$") %>%
str_trim(side = "both")) %>%
filter(str_detect(name, "\\w\\s?,\\s\\w"))
cop_df
cop_names <- unique(cop_df$name) %>% sort()
name_mtx <- stringdistmatrix(cop_names, cop_names, method = "dl", useNames = T)
name_mtx[lower.tri(name_mtx)] <- NA
similar <- as.data.frame(name_mtx) %>%
rownames_to_column(var = "name1") %>%
as_tibble() %>%
gather(key = name2, value = dist, -name1) %>%
filter(dist > 0 & dist < 4)
sim_names <- similar %>%
select(-dist) %>%
gather() %>%
distinct(value) %>%
pull(value)
sim_names
length(sim_names)
cop_df %>%
filter(name %in% sim_names)
similar %>%
select(-dist) %>%
gather() %>%
distinct(value)
cop_df %>%
filter(name %in% sim_names)
cop_df %>%
filter(name %in% sim_names) %>%
arrange(name)
similar %>%
select(-dist) %>%
gather()
similar %>%
# select(-dist) %>%
gather(-dist)
similar %>%
# select(-dist) %>%
gather(key, value, -dist)
sim_names <- similar %>%
# select(-dist) %>%
gather(key, value, -dist) %>%
distinct(value) %>%
pull(value)
dim(similar)
similar
cop_df
cop_df %>%
distinct(name, officer_id) %>%
unite(name_id, name, officer_id)
dim(name_mtx)
name_mtx[1:4, 1:4]
?possibly
